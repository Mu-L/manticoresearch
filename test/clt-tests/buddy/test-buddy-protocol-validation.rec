––– input –––
export SEARCHD_FLAGS="--logdebugvv"
––– output –––
––– block: ../base/start-searchd-with-buddy –––
––– input –––
export SEARCHD_FLAGS="--logdebugvv"
––– output –––
––– input –––
apt-get install jq -y > /dev/null; echo $?
––– output –––
debconf: delaying package configuration, since apt-utils is not installed
0
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE t (id INT, value TEXT, value_attr STRING) min_infix_len = '3'; INSERT INTO t VALUES (1, 'example', 'example'), (2, 'test', 'test');"
––– output –––
––– comment –––
Test MySQL commands that route to Buddy
––– input –––
mysql -h0 -P9306 -e "CREATE TABLE t_mysql_copy LIKE t;" && echo "OK"
––– output –––
OK
––– input –––
mysql -h0 -P9306 -e "DESCRIBE t;" | grep "id" | wc -l
––– output –––
1
––– comment –––
Test HTTP /cli_json commands that route to Buddy
––– input –––
curl -s "http://localhost:9308/cli_json?show%20buddy%20plugins" | jq '.[] | .data[0].Plugin'
––– output –––
"empty-string"
––– input –––
curl -s "http://localhost:9308/cli_json?select%20*%20from%20t%20where%20match('exmaple')%20option%20fuzzy=1" | jq '.[] | .data | length'
––– output –––
1
––– input –––
curl -s "http://localhost:9308/cli_json?create%20table%20t_copy%20like%20t" | jq '.[] | .total'
––– output –––
0
––– comment –––
Test HTTP /sql?mode=raw commands that route to Buddy
––– input –––
curl -s -X POST "http://localhost:9308/sql?mode=raw" -d "show buddy plugins" | jq '.[0].data[0].Plugin'
––– output –––
"empty-string"
––– input –––
curl -s -X POST "http://localhost:9308/sql?mode=raw" -d "describe t" | jq '.[0].data[0].Field'
––– output –––
"id"
––– comment –––
Test multi-query HTTP commands that route to Buddy
––– input –––
curl -s "http://localhost:9308/cli_json?select%20count(*)%20from%20t;show%20meta" | jq 'length'
––– output –––
2
––– comment –––
Test JSON HTTP commands that route to Buddy
––– input –––
curl -s -X POST "http://localhost:9308/search" -H "Content-Type: application/json" -d '{"index": "t", "query": {"match": {"value": "example"}}}' | jq '.hits.total'
––– output –––
1
––– input –––
curl -s "http://localhost:9308/cli_json?insert%20into%20auto_table%20(id,%20name)%20values%20(1,%20'test')" | jq '.[] | .total'
––– output –––
1
––– comment –––
Verify Buddy protocol v3 logging is working
––– input –––
grep -q "request data:" /var/log/manticore/searchd.log && echo "Protocol logging: ACTIVE" || echo "Protocol logging: MISSING"
––– output –––
Protocol logging: ACTIVE
––– input –––
grep -q "response data:" /var/log/manticore/searchd.log && echo "Response logging: ACTIVE" || echo "Response logging: MISSING"
––– output –––
Response logging: ACTIVE
––– comment –––
Check protocol v3 structure and content
––– input –––
grep "request data:" /var/log/manticore/searchd.log | grep -q '"version":3' && echo "Protocol version 3: FOUND" || echo "Protocol version 3: MISSING"
––– output –––
Protocol version 3: FOUND
––– input –––
grep "request data:" /var/log/manticore/searchd.log | grep -q '"type"' && echo "Type field: FOUND" || echo "Type field: MISSING"
––– output –––
Type field: FOUND
––– input –––
grep "request data:" /var/log/manticore/searchd.log | grep -q '"body"' && echo "Body field: FOUND" || echo "Body field: MISSING"
––– output –––
Body field: FOUND
––– comment –––
Verify specific Buddy commands are logged correctly
––– input –––
grep "request data:" /var/log/manticore/searchd.log | grep -q "show buddy plugins" && echo "SHOW BUDDY PLUGINS: LOGGED" || echo "SHOW BUDDY PLUGINS: NOT LOGGED"
––– output –––
SHOW BUDDY PLUGINS: LOGGED
––– input –––
grep "request data:" /var/log/manticore/searchd.log | grep -q "fuzzy" && echo "Fuzzy search: LOGGED" || echo "Fuzzy search: NOT LOGGED"
––– output –––
Fuzzy search: LOGGED
––– input –––
grep "request data:" /var/log/manticore/searchd.log | grep -q "show\|select\|insert" && echo "SQL commands: LOGGED" || echo "SQL commands: NOT LOGGED"
––– output –––
SQL commands: LOGGED
––– comment –––
Final validation - all required protocol v3 fields present
––– input –––
grep "request data:" /var/log/manticore/searchd.log | head -1 | grep -q '"version":3' && grep "request data:" /var/log/manticore/searchd.log | head -1 | grep -q '"type"' && grep "request data:" /var/log/manticore/searchd.log | head -1 | grep -q '"body"' && echo "Protocol v3 structure: COMPLETE" || echo "Protocol v3 structure: INCOMPLETE"
––– output –––
Protocol v3 structure: COMPLETE
